<form name='connect'>
    <p class='help'>Connect to your home WiFi network to get started.</p>
    <select id='ssid' name='ssid'>
        <option>Select your SSID</option>
    </select>
    <input id='pass' name='pass' type='password' placeholder='Password' />
    <button>Connect</button>
</form>
<p class='status'>Loading...</p>

<script>
    function $(s) { return document.querySelector(s); };
    var status_text = $('.status');
    document.forms['connect'].style.display = 'none';

    // Check connection status
    var check_connection_interval = null;

    function checkConnection() {
        var fetch_connection = fetch('/connection.json').then(function(resp) {
            return resp.json();
        });
        fetch_connection.then(handleConnection);
    };

    // Interpret and react to connection status
    function handleConnection(connection) {
        if (connection.status == 'connected') {
            window.location = '/register';
        }

        else if (connection.status == 'connecting') {
        }
        
        else {
            document.forms['connect'].style.display = 'block';
            loadScan();
            $('#ssid').focus();
            status_text.textContent = '';
        }
    }

    // Load available Wifi networks from scan
    function loadScan() {
        fetch('/scan.json').then(function (r) { return r.json() }).then(function (stations) {
            stations.sort(function(a, b) { return (a.rssi > b.rssi) ? -1 : 1; });
            stations.map(function (station) {
                var option = document.createElement('option');
                option.value = station.ssid;
                option.textContent = station.ssid;
                $('#ssid').appendChild(option);
            });
        });
    }

    checkConnection(); // Start by checking connection

    // Submit connect form -> post connection info, start checking connection status
    document.forms['connect'].onsubmit = function() {
        $('form[name=connect] button').textContent = 'Connecting...';
        $('form[name=connect] button').disabled = true;

        fetch('/connect.json', {
            method: 'post',
            body: JSON.stringify({
                ssid: $('#ssid').value,
                pass: $('#pass').value
            })
        });

        check_connection_interval = setInterval(checkConnection, 2500);
        return false;
    };
</script>
