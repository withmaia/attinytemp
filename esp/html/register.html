<form name='register'>
    <p class='help'>Enter the registration token you got from the Maia dashboard.</p>
    <p class='todo'>TODO: Check network connection with Javascript</p>
    <input id='token' name='token' placeholder='Token' />
    <button>Register</button>
</form>
<p class='status'>Loading...</p>

<script>
    function $(s) { return document.querySelector(s); };
    var status_text = $('.status');
    document.forms['register'].style.display = 'none';

    // Check registration status
    var check_registration_interval = null;

    function checkRegistration() {
        var fetch_registration = fetch('/registration.json').then(function(resp) {
            return resp.json();
        });
        fetch_registration.then(handleRegistration);
    };

    // Interpret and react to registration status
    function handleRegistration(registration) {
        if (registration.status == 'registered') {
            clearInterval(check_registration_interval);
            document.forms['register'].style.display = 'none';
            status_text.innerHTML =
                "<p class='help'>Your device is now registered to " + registration.email + "</p>"
                + "<p class='note'>Remember to switch back to your home wifi network!</p>";
        }

        else {
            document.forms['register'].style.display = 'block';
            $('#token').focus();
            status_text.textContent = '';
        }
    }

    checkRegistration(); // Start by checking registration

    // Submit registration form -> post registration, start checking registration status
    document.forms['register'].onsubmit = function() {
        $('form[name=register] button').textContent = 'Registering...';
        $('form[name=register] button').disabled = true;

        fetch('/register.json', {
            method: 'post',
            body: JSON.stringify({
                token: $('#token').value
            })
        });

        check_registration_interval = setInterval(checkRegistration, 2500);
        return false;
    };
</script>

